<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Inline Web Worker</title>

    <script src="./inline-worker.js"></script>
  </head>
  <body>

    <p>Support</p>
    <ul>
      <li> <a href="https://caniuse.com/#feat=webworkers">Web Workers</a> </li>
      <li> <a href="https://caniuse.com/#feat=blobbuilder">Blob Constructor</a> </li>
      <li> <a href="https://caniuse.com/#feat=bloburls">URL from Blob</a> </li>
    </ul>

    <script type="text/javascript">

    window.onload = function () {

      /*
       * Run
       * Instantiate a new worker that run a single function, once.
       */

      InlineWorker.run(function () {
        return 1 + 2;
      }).then(function (e) {
        console.log("1.","worker message:", e.data);
      });

      InlineWorker.run(function (a, b) {
        return a + b;
      }, 1, 2).then(function (e) {
        console.log("2.", "worker message:", e.data);
      });

      var task = InlineWorker.run(function (a, b, c) {
        return "" + a + b + c;
      }, 1, "a", "1+2*8");
      task.then(function (e) {
        console.log("3.", "worker message:", e.data);
      });

      /*
       * Create
       * Instantiate a new worker that can run a function multiple times
       * onmessage event is passed as first argument
       */

      var workerBasic = InlineWorker.create(function (e) {
        return "ok: " + e.data;
      });
      workerBasic.onmessage = function (e) {
        console.log("4.", "worker message:", e.data);
      }
      workerBasic.postMessage("hello");
      workerBasic.postMessage("world");

      var workerMinMax = InlineWorker.create(function (e, min, max) {
        return Math.min(Math.max(e.data, min), max);
      }, 0, 1);
      workerMinMax.onmessage = function (e) {
        console.log("5.", "worker message:", e.data);
      }
      workerMinMax.postMessage(0.5);
      workerMinMax.postMessage(1.2);

      /*
       * New
       * Instantiate a new worker, with any arguments
       */

      var countWorker = InlineWorker.new(function (name, count) {
        self.onmessage = function (e) {
          count++;
          postMessage("" + name + ", count = " + count);
        }
      }, "'Worker Name'", 0);
      countWorker.onmessage = function (e) {
        console.log("6.", "worker message:", e.data);
      }
      countWorker.postMessage(null);
      countWorker.postMessage(null);

      function concat(a, b) {
        return "" + a + "," + b;
      }
      function split(string) {
        return string.split(",");
      }
      var composedWorker = InlineWorker.new(function (localSplit, localConcat) {
        self.onmessage = function (e) {
          var string = ""
          for (var i = 0; i < e.data.length; i++) {
            string = localConcat(string, e.data[i]);
          }
          var result = localSplit(string);
          postMessage(result);
        }
      }, split, concat);
      composedWorker.onmessage = function (e) {
        console.log("7.", "worker message:", e.data);
      }
      composedWorker.postMessage([1, 2]);
      composedWorker.postMessage(["a", "b", "c"]);

      /*
       * Delay does not block UI
       */

      var longWorker = InlineWorker.run(function () {
        var values = new Array(1<<24);
        for (var i = 0; i < values.length; i++) {
          values[i] = i << 24;
        }
        return values;
      }).then(function (e) {
        console.log("8.", "worker message:", e.data.length);
      });
    }
    </script>

  </body>
</html>
